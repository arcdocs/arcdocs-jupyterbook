

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Matlab {#matlab .entry-title} &#8212; ARC Documentation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-dropdown.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/sphinx-book-theme.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://arcdocs.github.io/arcdocs-jupyterbook/software/matlab.html" />
    <link rel="shortcut icon" href="../_static/favicon-32x32.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">


<!-- Opengraph tags -->
<meta property="og:url"         content="https://arcdocs.github.io/arcdocs-jupyterbook/software/matlab.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Matlab {#matlab .entry-title}" />
<meta property="og:description" content="Matlab {#matlab .entry-title}  Matlab is installed on the HPC clusters and is licensed for academic use only.  ::: {#toc_container .no_bullets} Contents  [1]{.t" />
<meta property="og:image"       content="https://arcdocs.github.io/arcdocs-jupyterbook/_static/logo.png" />

<meta name="twitter:card" content="summary" />


  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">ARC Documentation</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../welcome.html">
   Welcome
  </a>
 </li>
</ul>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started/start.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../useage/start.html">
   Useage
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="start.html">
   Software
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../systems/start.html">
   Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://arcleeds.github.io/training/">
   Training
   <i class="fas fa-external-link-alt">
   </i>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contact/start.html">
   Contact Us
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Visit the <a href="https://arcleeds.github.io/">Research Computing Home Site</a> <div> This book is powered by <a href="https://jupyterbook.org">Jupyter Book</a> </div>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/software/matlab.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/arcdocs/arcdocs-jupyterbook"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/arcdocs/arcdocs-jupyterbook/issues/new?title=Issue%20on%20page%20%2Fsoftware/matlab.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/arcdocs/arcdocs-jupyterbook/edit/working-master/book/software/matlab.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setting-up-the-environment-setting-up-the-environment">
   [Setting up the environment]{#Setting_up_the_environment}
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#running-on-the-login-nodes-running-on-the-login-nodes">
   [Running on the login nodes]{#Running_on_the_login_nodes}
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#running-through-the-batch-scheduler-running-through-the-batch-scheduler">
   [Running through the batch scheduler]{#Running_through_the_batch_scheduler}
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#running-through-an-interactive-shell-running-through-an-interactive-shell">
     [Running through an interactive shell]{#Running_through_an_interactive_shell}
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#batch-execution-batch-execution">
     [Batch Execution]{#Batch_Execution}
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parallel-matlab-jobs-parallel-matlab-jobs">
   [Parallel Matlab jobs]{#Parallel_Matlab_jobs}
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multi-threaded-support-multi-threaded-support">
     [Multi-threaded support]{#Multi-threaded_support}
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multiple-worker-support-on-a-single-host-multiple-worker-support-on-a-single-host">
     [Multiple “worker” support (on a single host)]{#Multiple_worker_support_on_a_single_host}
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multiple-worker-support-on-multiple-hosts-multiple-worker-support-on-multiple-hosts">
     [Multiple “worker” support (on multiple hosts)]{#Multiple_worker_support_on_multiple_hosts}
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gpu-matlab-jobs-gpu-matlab-jobs">
   [GPU Matlab jobs]{#GPU_Matlab_jobs}
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compiling-matlab-compiling-matlab">
   [Compiling Matlab]{#Compiling_Matlab}
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-preparation-code-preparation">
     [Code preparation]{#Code_preparation}
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compiling-compiling">
     [Compiling]{#Compiling}
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#running-the-application-running-the-application">
     [Running the application]{#Running_the_application}
    </a>
   </li>
  </ul>
 </li>
</ul>

        </nav>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="matlab-matlab-entry-title">
<h1>Matlab {#matlab .entry-title}<a class="headerlink" href="#matlab-matlab-entry-title" title="Permalink to this headline">¶</a></h1>
<p>Matlab is installed on the HPC clusters and is licensed for academic use
only.</p>
<p>::: {#toc_container .no_bullets}
Contents</p>
<ul class="simple">
<li><p><a class="reference external" href="#Setting_up_the_environment">[1]{.toc_number .toc_depth_1} Setting up the
environment</a></p></li>
<li><p><a class="reference external" href="#Running_on_the_login_nodes">[2]{.toc_number .toc_depth_1} Running on the login
nodes</a></p></li>
<li><p><a class="reference external" href="#Running_through_the_batch_scheduler">[3]{.toc_number .toc_depth_1} Running through the batch
scheduler</a></p>
<ul>
<li><p><a class="reference external" href="#Running_through_an_interactive_shell">[3.1]{.toc_number .toc_depth_2} Running through an interactive
shell</a></p></li>
<li><p><a class="reference external" href="#Batch_Execution">[3.2]{.toc_number .toc_depth_2} Batch
Execution</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#Parallel_Matlab_jobs">[4]{.toc_number .toc_depth_1} Parallel Matlab
jobs</a></p>
<ul>
<li><p><a class="reference external" href="#Multi-threaded_support">[4.1]{.toc_number .toc_depth_2} Multi-threaded
support</a></p></li>
<li><p><a class="reference external" href="#Multiple_worker_support_on_a_single_host">[4.2]{.toc_number .toc_depth_2} Multiple “worker” support (on
a single host)</a></p></li>
<li><p><a class="reference external" href="#Multiple_worker_support_on_multiple_hosts">[4.3]{.toc_number .toc_depth_2} Multiple “worker” support (on
multiple hosts)</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#GPU_Matlab_jobs">[5]{.toc_number .toc_depth_1} GPU Matlab jobs</a></p></li>
<li><p><a class="reference external" href="#Compiling_Matlab">[6]{.toc_number .toc_depth_1} Compiling Matlab</a></p>
<ul>
<li><p><a class="reference external" href="#Code_preparation">[6.1]{.toc_number .toc_depth_2} Code
preparation</a></p></li>
<li><p><a class="reference external" href="#Compiling">[6.2]{.toc_number .toc_depth_2} Compiling</a></p></li>
<li><p><a class="reference external" href="#Running_the_application">[6.3]{.toc_number .toc_depth_2} Running the
application</a>
:::</p></li>
</ul>
</li>
</ul>
<div class="section" id="setting-up-the-environment-setting-up-the-environment">
<h2>[Setting up the environment]{#Setting_up_the_environment}<a class="headerlink" href="#setting-up-the-environment-setting-up-the-environment" title="Permalink to this headline">¶</a></h2>
<p>All required environment variables can be set by loading the Matlab
module, to do this type the command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ module add matlab
</pre></div>
</div>
<p>Matlab is now centrally licenced and managed so there is no need to set
a licence server before using it.</p>
</div>
<div class="section" id="running-on-the-login-nodes-running-on-the-login-nodes">
<h2>[Running on the login nodes]{#Running_on_the_login_nodes}<a class="headerlink" href="#running-on-the-login-nodes-running-on-the-login-nodes" title="Permalink to this headline">¶</a></h2>
<p>Matlab can be launched by entering its name at the command prompt; i.e.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ matlab
</pre></div>
</div>
<p>Please note that this method should not be used for long computational
use.</p>
</div>
<div class="section" id="running-through-the-batch-scheduler-running-through-the-batch-scheduler">
<h2>[Running through the batch scheduler]{#Running_through_the_batch_scheduler}<a class="headerlink" href="#running-through-the-batch-scheduler-running-through-the-batch-scheduler" title="Permalink to this headline">¶</a></h2>
<p>The batch scheduler allows both interactive and batch jobs to be
submitted during which users will have exclusive access to the resources
they request.</p>
<div class="section" id="running-through-an-interactive-shell-running-through-an-interactive-shell">
<h3>[Running through an interactive shell]{#Running_through_an_interactive_shell}<a class="headerlink" href="#running-through-an-interactive-shell-running-through-an-interactive-shell" title="Permalink to this headline">¶</a></h3>
<p>The following will launch Matlab interactively, displaying the full GUI:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ qrsh -V -l h_rt=hh:mm:ss matlab -desktop -singleCompThread
</pre></div>
</div>
<p>In the above command:<br />
[hh:mm:ss]{.lang:default .decode:true .crayon-inline} is the length of
real-time the shell will exist for,<br />
[-V]{.lang:default .decode:true .crayon-inline} exports the the current
environment.</p>
<p>The parameter [-singleCompThread]{.lang:default .decode:true
.crayon-inline} ensures that Matlab will run only on a single thread,
since the default multiple threaded behaviour can cause problems.</p>
<p>e.g. to run Matlab for 6 hours:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ qrsh -V -l h_rt=6:00:00 matlab -desktop -singleCompThread
</pre></div>
</div>
<p>This will run Matlab within the terminal from which it was launched.</p>
<p>Alternatively, the following will launch an interactive session where
the interaction is via a command prompt interface only:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ qrsh -pty y -V -l h_rt=6:00:00 matlab -nodesktop -singleCompThread
</pre></div>
</div>
<p>Where, [hh:mm:ss]{.lang:default .decode:true .crayon-inline} is the
length of real-time the shell will exist for.</p>
</div>
<div class="section" id="batch-execution-batch-execution">
<h3>[Batch Execution]{#Batch_Execution}<a class="headerlink" href="#batch-execution-batch-execution" title="Permalink to this headline">¶</a></h3>
<p>To run matlab in batch-mode you must first generate a list of commands
for matlab to process in a file; e.g. file [cosplot.m]{.lang:default
.decode:true .crayon-inline}:</p>
<p><em>The [%]{.lang:default .decode:true .crayon-inline} symbol denotes a
comment in Matlab scripts</em></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>% MATLAB M-file example to approximate a sawtooth
% with a truncated Fourier expansion.
nterms=5;
fourbypi=4.0/pi;
np=100;
y(1:np)=pi/2.0;
x(1:np)=linspace(-2.0*pi,2*pi,np);
for k=1:nterms
twokm=2*k-1;
y=y-fourbypi*cos(twokm*x)/twokm^2;
end;
plot(x,y);
print -deps matlab_test_plot.ps;
quit;
</pre></div>
</div>
<p>Please note that the last line must be ” [quit;]{.lang:default
.decode:true .crayon-inline} “!</p>
<p>A script must then be created that will request resources from the
queuing system and launch the matlab executable; script
[runmatlab.sh]{.lang:default .decode:true .crayon-inline}:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Export current environment  
#$ -V
# Set a 10 min limit
#$ -l h_rt=0:10:00
# Load matlab module
module add matlab
# run matlab using command file
# -nodisplay flag should be given to suppress graphics
matlab -nodisplay &lt; cosplot.m
</pre></div>
</div>
<p>This can be submitted to the batch scheduler system using:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ qsub runmatlab.sh
</pre></div>
</div>
<p>The output file [matlab_test_plot.ps<br />
]{.lang:default .decode:true .crayon-inline} can be viewed with
Ghostscript using the command [gs matlab_test_plot.ps]{.lang:default
.decode:true .crayon-inline}.</p>
</div>
</div>
<div class="section" id="parallel-matlab-jobs-parallel-matlab-jobs">
<h2>[Parallel Matlab jobs]{#Parallel_Matlab_jobs}<a class="headerlink" href="#parallel-matlab-jobs-parallel-matlab-jobs" title="Permalink to this headline">¶</a></h2>
<p>Recent versions of Matlab support three methods of making use of
multiple CPU cores:</p>
<ol class="simple">
<li><p>Multi-threaded support in various Matlab routines and toolboxes</p></li>
<li><p>Multiple “worker” support (on a single host)</p></li>
<li><p>Multiple “worker” support (on multiple hosts)</p></li>
</ol>
<div class="section" id="multi-threaded-support-multi-threaded-support">
<h3>[Multi-threaded support]{#Multi-threaded_support}<a class="headerlink" href="#multi-threaded-support-multi-threaded-support" title="Permalink to this headline">¶</a></h3>
<p>This is the simplest method of allowing Matlab to use more than one CPU
core. Many functions and toolboxes, for example [fft()]{.lang:default
.decode:true .crayon-inline} and various linear algebra routines,
automatically make use of multiple cores where available.</p>
<p>To do this, we would recommend adding the flag [-l
nodes=1,ppn=1]{.lang:default .decode:true .crayon-inline} to your qsub
command and job scripts. This will ask for an entire compute node. Note
that this will <strong>NOT</strong> speed up Matlab while it is not using functions
that are able to take advantage of multiple cores.</p>
<p>Please see the Matlab product documentation for details on what
functions are multithreaded.</p>
</div>
<div class="section" id="multiple-worker-support-on-a-single-host-multiple-worker-support-on-a-single-host">
<h3>[Multiple “worker” support (on a single host)]{#Multiple_worker_support_on_a_single_host}<a class="headerlink" href="#multiple-worker-support-on-a-single-host-multiple-worker-support-on-a-single-host" title="Permalink to this headline">¶</a></h3>
<p>Matlab can launch multiple copies of itself, called workers, that are
able to communicate and share work between them. This functionality is
called the Parallel Toolbox and you may need to adjust code to work
properly in this fashion. For example, [for]{.lang:default .decode:true
.crayon-inline} loops that can be run in parallel may be distributed
across all workers by use of the [parfor]{.lang:default .decode:true
.crayon-inline} Matlab command.</p>
<p>To do this, launch a parallel job, for example by adding the [-pe smp
8]{.lang:default .decode:true .crayon-inline} flag to the qrsh or qsub
commands from above. This requests 8 cores on a single compute node and
stores the number of cores granted in the NSLOTS environment variable.
Once it has started, execute the Matlab command [parpool(‘local’,
8)]{.lang:default .decode:true .crayon-inline} or, more generally,
[parpool(‘local’, str2num(getenv(‘NSLOTS’)))]{.lang:default
.decode:true .crayon-inline}, which in this case would launch 8 workers.</p>
<p>According to Matlab’s documentation, there may be a limit on the number
of workers that can be requested in this way; however, this has been
tested on ARC3 on up to 24 cores.</p>
</div>
<div class="section" id="multiple-worker-support-on-multiple-hosts-multiple-worker-support-on-multiple-hosts">
<h3>[Multiple “worker” support (on multiple hosts)]{#Multiple_worker_support_on_multiple_hosts}<a class="headerlink" href="#multiple-worker-support-on-multiple-hosts-multiple-worker-support-on-multiple-hosts" title="Permalink to this headline">¶</a></h3>
<p>The multiple workers in the Parallel Toolbox can be spread across
multiple hosts in order to make use of a greater number of cores and/or
memory: Matlab calls this the Distributed Computing Server. Although
this is very similar technology, Mathworks license it differently: at
the time of writing we can only support a maximum of 32 distributed
workers - please contact arc-help&#64;lists.leeds.ac.uk if this limits your
research.</p>
<p>The same code that can make use of the Parallel Toolbox can also make
use of Distributed Computing Server; however, there are currently a few
setup steps required and the method of launching it is different.</p>
<p><strong>NOTE:</strong> these instructions were put together using Matlab 2017b.</p>
<p>Setup steps:</p>
<ul class="simple">
<li><p><em>Configure Matlab to use an appropriate MPI.</em> Execute the following
commands:</p>
<ul>
<li><p>[$ mkdir ~/matlab]{.lang:default .decode:true .crayon-inline}</p></li>
<li><p>[$ cp
$SGE_ROOT/$SGE_CELL/common/leeds/pe/matlab/mpiLibConf.m
~/matlab/]{.lang:default .decode:true .crayon-inline}</p></li>
</ul>
</li>
<li><p><em>Configure Matlab to submit batch jobs.</em> Launch Matlab on a login
node and:</p>
<ul>
<li><p>From the toolbar, select: <em>HOME -&gt; Parallel -&gt; Manage Cluster
Profiles</em></p></li>
<li><p>Select <em>Import</em></p></li>
<li><p>Select file
[/services/sge_prod/default/common/leeds/pe/matlab/Gridengine.settings]{.lang:default
.decode:true .crayon-inline}</p></li>
</ul>
</li>
</ul>
<p><em>(these steps should become redundant in future installations of Matlab
on ARC)</em></p>
<p>To use:</p>
<ul class="simple">
<li><p>Launch Matlab on a login node and <em>NOT</em> from inside a job.</p></li>
<li><p>Launch a 32 worker distributed pool with the following Matlab
command: [pool = parpool(‘Gridengine’, 32);]{.lang:default
.decode:true .crayon-inline}</p></li>
<li><p>This causes Matlab to submit a 32 core job. Once it has started
running, you will be able to type further commands.</p></li>
</ul>
<p>By default, a Gridengine parpool requests one core and 1G RAM per worker
for 48 hours. Control over the type of job can be achieved by editing
the cluster profile within Matlab. For example, to change the job
runtime (h_rt), memory per worker (h_vmem) or add arbitrary qsub flags
(qsub_args):</p>
<ol class="simple">
<li><p>From toolbar, select: <em>HOME -&gt; Parallel -&gt; Manage Cluster
Profiles</em></p></li>
<li><p>Click on <em>Gridengine</em> (on left hand side)</p></li>
<li><p>Click on <em>Properties</em> tab (on right hand side)</p></li>
<li><p>Click on <em>Edit</em> button (bottom right)</p></li>
<li><p>Scroll to the <em>AdditionalProperties</em> box in the <em>SCHEDULER
INTEGRATION</em> section.</p></li>
<li><p>Select the vale for <em>h_rt</em>, <em>h_vmem</em> or <em>qsub_args</em> and modify
accordingly.</p></li>
<li><p>Click on <em>Done</em> button (bottom right)</p></li>
</ol>
<p><em>Hybrid multiple workers and multithreading parallelisation</em>. It may be
useful to try combining both Matlab’s multithreading and Distributed
Computing Server features (for example, your Matlab code spends all its
time in a parfor loop and each trip through that loop spends all of its
time in multithreaded routines like fft()): if appropriate, this would
make the best use of our limited Distributed Computing Server licenses.
To do this:</p>
<ul class="simple">
<li><p>Use the above method for changing <em>h_rt</em> to edit the cluster
profile but instead change <em>use_np_syntax</em> to <em>true</em>. This will
caluse entire compute nodes to be allocated to the pool.</p></li>
<li><p>Repeat steps 1-4 again, but then change the value for <em>NumThreads</em>
(instead of modifying the <em>AdditionalProperties</em> box). This will
tell Matlab to multithread and it will also cause <em>NumThread</em> cores
to be allocated to each worker.</p></li>
<li><p>Since entire compute nodes are allocated, please select ‘sensible’
values for the number of workers and the number of cores per worker
to make good use of the allocated resources. For example, on ARC3’s
24 core compute nodes, the number of workers in the pool multiplied
by <em>NumThreads</em> should be a multiple of 24.</p></li>
</ul>
<p>Troubleshooting Distributed Computing Server:</p>
<ul class="simple">
<li><p><em>No matter how many workers I ask for, parpool reports there is only
1 worker!</em> MPI has probably not been configured correctly and Matlab
is running multiple workers that cannot communicate with each other.
Ensure you have copied mpiLibConf.m (see above) and restart Matlab.</p></li>
<li><p><em>When the pool is shutdown, the job goes into an error state
(“Eqw”).</em> Matlab often deletes the files associated with the jobs
it submits before the jobs themselves are deleted. If this happens,
please qdel the job manually.</p></li>
</ul>
</div>
</div>
<div class="section" id="gpu-matlab-jobs-gpu-matlab-jobs">
<h2>[GPU Matlab jobs]{#GPU_Matlab_jobs}<a class="headerlink" href="#gpu-matlab-jobs-gpu-matlab-jobs" title="Permalink to this headline">¶</a></h2>
<p>Matlab can take advantage of GPU hardware. To do this, first launch
Matlab inside a job where GPU resources have been requested (see
<a class="reference external" href="https://arc.leeds.ac.uk/using-the-systems/why-have-a-scheduler/gpgpu/">here</a>).
Within Matlab, the [gpuDevices]{.lang:default .decode:true
.crayon-inline} command will provide details of the available GPU(s):</p>
<p>e.g.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt; gpuDevice

ans = 

  CUDADevice with properties:

                      Name: &#39;Tesla P100-PCIE-12GB&#39;
                     Index: 1
         ComputeCapability: &#39;6.0&#39;
            SupportsDouble: 1
             DriverVersion: 9
            ToolkitVersion: 8
        MaxThreadsPerBlock: 1024
          MaxShmemPerBlock: 49152
        MaxThreadBlockSize: [1024 1024 64]
               MaxGridSize: [2.1475e+09 65535 65535]
                 SIMDWidth: 32
               TotalMemory: 1.2786e+10
           AvailableMemory: 1.2401e+10
       MultiprocessorCount: 56
              ClockRateKHz: 1328500
               ComputeMode: &#39;Default&#39;
      GPUOverlapsTransfers: 1
    KernelExecutionTimeout: 0
          CanMapHostMemory: 1
           DeviceSupported: 1
            DeviceSelected: 1
</pre></div>
</div>
<p>Please see the main Matlab product documentation for writing code to use
GPUs.</p>
<p>Multiple GPUs can also be taken advantage of; however, this must be in
conjunction with the Parallel Toolbox feature (see the above section on
parallel jobs and the Matlab website) as a single worker can only use
one GPU at a time.</p>
</div>
<div class="section" id="compiling-matlab-compiling-matlab">
<h2>[Compiling Matlab]{#Compiling_Matlab}<a class="headerlink" href="#compiling-matlab-compiling-matlab" title="Permalink to this headline">¶</a></h2>
<p>To run a large number of matlab jobs simultaneously it may be necessary
to use the matlab compiler to create a stand-alone application. This
will also avoid using too many license tokens. For a full description of
the compiler please look at the in-program help or the <a class="reference external" href="http://www.mathworks.co.uk/help/toolbox/compiler/index.html">Matlab compiler
user’s
guide</a>.</p>
<div class="section" id="code-preparation-code-preparation">
<h3>[Code preparation]{#Code_preparation}<a class="headerlink" href="#code-preparation-code-preparation" title="Permalink to this headline">¶</a></h3>
<p><em><strong>Script</strong></em> m-files cannot be compiled directly, first they have to be
converted to <em><strong>function</strong></em> m-files. In general, this is a case of
wrapping the main section of code within a function. For more details
look at <a class="reference external" href="http://www-rohan.sdsu.edu/doc/matlab/toolbox/compiler/ch03get9.html">converting script
m-files</a>
section in the user guide.</p>
</div>
<div class="section" id="compiling-compiling">
<h3>[Compiling]{#Compiling}<a class="headerlink" href="#compiling-compiling" title="Permalink to this headline">¶</a></h3>
<p>The Matlab compiler makes use of the GNU C compilers and as the Intel
compiler is loaded by default you shouldswitch to the correct version of
GNU compiler via the command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>module switch intel gnu
</pre></div>
</div>
<p>The compiler can be invoked from within Matlab or directly from the
command line via the tool [mcc]{.lang:default .decode:true
.crayon-inline} . However, to get the code to compile in single threaded
mode the compiler should be invoked directly from the command line. In
general this would take the form:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mcc -R -singleCompThread  -m your_program.m
</pre></div>
</div>
<p>It is very important that you include the [-R
singleCompThread]{.lang:default .decode:true .crayon-inline}, otherwise
matlab will run in multi-threaded mode and cause problems when running
through the batch queues.</p>
<p>This compilation will yield two files of interest</p>
<ul class="simple">
<li><p>[your_program]{.lang:default .decode:true .crayon-inline} , which
is the compiled code</p></li>
<li><p>[runyourprogram.sh]{.lang:default .decode:true .crayon-inline} ,
which is the wrapper to run your compiled code.</p></li>
</ul>
</div>
<div class="section" id="running-the-application-running-the-application">
<h3>[Running the application]{#Running_the_application}<a class="headerlink" href="#running-the-application-running-the-application" title="Permalink to this headline">¶</a></h3>
<p>Once the matlab module is loaded, you can run your stand-alone
application via the wrapper and specifing the correct path to various
Matlab components. This can easily be done via the environment variable
[$MATLAB_HOME]{.lang:default .decode:true .crayon-inline}. An example
job script for submission to the batch queue would look like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Export current environment  
#$ -V
# Set a 6 hour limit
#$ -l h_rt=6:00:00
# Load matlab module
module add matlab
#set the path to Matlab runtime, via $MATLAB_HOME, run program via wrapper
./run_your_program.sh $MATLAB_HOME 
</pre></div>
</div>
<p>:::</p>
<p>::: {.entry-meta}
:::
:::
:::
:::</p>
<p>::: {.container}
::: {.site-info}
::: {.footer-credit}
Built with <a class="reference external" href="https://thethemefoundry.com/make/">Make</a>{.theme-name}. Your
friendly WordPress page builder theme.
:::
:::
:::
:::</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./software"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By University of Leeds Research Computing Team<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    <script src="../_static/js/index.js"></script>
    
  </body>
</html>